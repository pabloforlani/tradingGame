<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Futures Trading Simulator</title>
    <!-- <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-image: url("asset/background.jpg");
            color: white;
            
        }
        canvas {
            border-radius: 25px;
        }
        .container {
            max-width: 600px;
            margin: auto;
            border-radius: 10px;
        }
        .section {
            margin-bottom: 20px;
        }
        button {
            margin: 5px;
            padding: 10px 20px;
            cursor: pointer;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 20px;
            overflow: hidden;
        }
        th, td {
            color: black;
            /* border: 1px solid #ddd; */
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #f4f4f4;
        }
        .profit {
            background-color: #d4f8d4;
        }
        .loss {
            background-color: #f8d4d4;
        }
        #reset-button{
            color: white;
        }
        #buy-button{
            background-color: #5bc55b;
        }
        #sell-button{
            background-color: #c43434;
            color: white;
        }
    </style> -->
    <!-- <style>
        /* General Styles */
        body {
            font-family: 'Inter', Arial, sans-serif; /* Moderna y profesional */
            background-color: #121212; /* Fondo negro */
            color: #e0e0e0; /* Texto gris claro */
            margin: 0;
            padding: 0;
        }
    
        .container {
            width: 90%;
            max-width: 1200px;
            margin: 20px auto;
            background: #1e1e1e; /* Fondo oscuro pero ligeramente más claro que el body */
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.8); /* Sombra fuerte para destacar */
            padding: 20px;
        }
    
        h3 {
            margin-top: 0;
            color: #00d9a3; /* Verde azulado llamativo */
            font-size: 1.5rem;
            border-bottom: 2px solid #00d9a3; /* Línea decorativa */
            padding-bottom: 5px;
        }
    
        p, label {
            font-size: 1rem;
            line-height: 1.5;
        }
    
        a {
            color: #1e88e5; /* Azul claro */
            text-decoration: none;
        }
    
        a:hover {
            text-decoration: underline;
        }
    
        /* Buttons */
        button {
            padding: 10px 16px;
            margin: 5px;
            border: none;
            border-radius: 8px; /* Bordes redondeados */
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease-in-out; /* Animación suave */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.6); /* Sombra para botones */
        }
    
        .btn-buy {
            background-color: #00d9a3; /* Verde brillante */
            color: #121212;
        }
    
        .btn-sell {
            background-color: #ff5252; /* Rojo brillante */
            color: #121212;
        }
    
        .btn-close {
            background-color: #1e88e5; /* Azul claro */
            color: #121212;
        }

        .btn-reset {
            background-color: #7190ac; /* Azul claro */
            color: #121212;
        }
    
        button:hover {
            transform: scale(1.05); /* Zoom al pasar el mouse */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.9); /* Sombra más fuerte */
        }
    
        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(167, 120, 20, 0.8); /* Sombra para destacar */
        }
    
        th, td {
            text-align: center;
            padding: 12px;
            font-size: 0.9rem;
        }
    
        th {
            background-color: #282828; /* Encabezado más claro */
            color: #00d9a3; /* Verde llamativo */
            text-transform: uppercase;
            font-weight: 600;
        }
    
        td {
            /*background-color: #1e1e1e; /* Fondo oscuro */
            color: #e0e0e0; /* Texto claro */
        }       
    
        .profit {
            background-color: #004d40; /* Verde oscuro para ganancias */
            color: #00d9a3;
        }
    
        .loss {
            background-color: #4d1a1a; /* Rojo oscuro para pérdidas */
            color: #ff5252;
        }
    
        /* Canvas */
        canvas {
            display: block;
            margin: 20px auto;
            border-radius: 12px;
            background-color: #1e1e1e; /* Fondo oscuro */
            box-shadow: 0 4px 12px rgba(192, 221, 29, 0.8); /* Sombra */
        }
    
        /* Inputs */
        input, select {
            padding: 10px;
            margin: 5px 0;
            font-size: 1rem;
            border: 1px solid #333;
            border-radius: 8px;
            transition: border-color 0.3s ease-in-out;
            background-color: #1e1e1e; /* Fondo oscuro */
            color: #e0e0e0; /* Texto claro */
            width: calc(100% - 20px);
            max-width: 300px;
        }
    
        input:focus, select:focus {
            border-color: #00d9a3; /* Verde brillante al enfocar */
            outline: none;
        }
    
        /* Footer (Opcional) */
        footer {
            text-align: center;
            margin-top: 20px;
            padding: 10px 0;
            background-color: #282828;
            color: #e0e0e0;
            font-size: 0.8rem;
        }
    
        footer a {
            color: #00d9a3;
        }
    
        footer a:hover {
            text-decoration: underline;
        }

        #function-button{
            align-items: center;
        }
    </style> -->
    <link rel="stylesheet" href="style.css">
    
</head>
<body>
    <div class="container">
        <h1>Futures Trading Simulator</h1>

        <div class="section">
            <h3>Price Chart:</h3>
            <div id="zoom-button">
                <button id="1x-button">1X</button>
            <button id="2x-button">2X</button>
            <button id="4x-button">4X</button>
            <button id="8x-button">8X</button>
            <br>
            </div>

            <canvas id="price-chart" width="800" height="500"></canvas>

            <div id="function-button">
                <button id="buy-button" class="btn-buy">Buy</button>
            <button id="sell-button" class="btn-sell">Sell</button>
            </div>
            
            
        </div>

        <!-- Price Section -->
        <div class="section">
            <h3>Current Price: <span id="current-price">Loading...</span> USDT</h3>
        </div>

        <!-- Balance Section -->
        <div class="section">
            <h3>Balance: <span id="balance">100.00</span> USDT</h3>
        </div>

        <!-- Controls Section -->
        <div class="section">
            <label for="leverage">Leverage: </label>
            <input type="number" id="leverage" value="1" min="1" max="125" step="1">
            
        </div>

        <!-- Investment Amount -->
        <div class="section">
            <label for="investment-option">Investment Option: </label>
            <select id="investment-option">
                <option value="fixed">Fixed Amount</option>
                <option value="percentage">Percentage of Balance</option>
            </select>
            <br>
            <label for="investment-amount">Investment Value: </label>
            <input type="number" id="investment-amount" value="10.00" step="0.01" min="0.01">
        </div>

        <!-- Take Profit / Stop Loss -->
        <div class="section">
            <label for="take-profit">Take Profit (%): </label>
            <input type="number" id="take-profit" value="0.05" step="0.1">
            <br>
            <label for="stop-loss">Stop Loss (%): </label>
            <input type="number" id="stop-loss" value="0.05" step="0.1">
        </div>

        <button id="reset-button" class="btn-reset" >Reset</button>

        <!-- PnL Section -->
        <div class="section">
            <h3>PNL</h3>
            <p id="pnl">Total PNL: 0.00 USDT | 0.00% (Open: 0.00 | 0.00% / Closed: 0.00 | 0.00%)</p>
        </div>

        <!-- Orders Section -->
        <div class="section">
            <h3>Open Orders:</h3>
            <button id="close-all-orders" class="btn-close">Close All Orders</button>
            <table>
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Price</th>
                        <th>Leverage</th>
                        <th>Investment</th>
                        <th>Take Profit</th>
                        <th>Stop Loss</th>
                        <th>PNL(USDT)</th>
                        <th>PNL(%)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="orders-list">
                    <!-- Orders will appear here -->
                </tbody>
            </table>
        </div>

        <!-- Closed Orders Section -->
        <div class="section">
            <h3>Closed Orders:</h3>
            <table>
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Opened Price</th>
                        <th>Closed Price</th>
                        <th>Leverage</th>
                        <th>Investment</th>
                        <th>PNL(USDT)</th>
                        <th>PNL(%)</th>
                    </tr>
                </thead>
                <tbody id="closed-orders-list">
                    <!-- Closed Orders will appear here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- <script>
        const balanceInicial = 100.00;
        let balance = balanceInicial;
        let orders = [];
        let closedOrders = [];
        let closedPnL = 0; // Acumulador de PNL cerrado
        let closedPnLPorc = 0; // Acumulador de PNL cerrado
        let openPnL = 0;
        let openPnLPorc = 0;
        let totalPnL = 0;
        let totalPnLPorc = 0;


        async function fetchPrice() {
            try {
                const response = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT');
                //const response = await fetch("https://api.kraken.com/0/public/Ticker?pair=XXBTZUSD"); 
                const data = await response.json();
                return parseFloat(data.price);
                //return parseFloat(data.result.XXBTZUSD.p[0]); //Precio promedio ponderado en las últimas 24 horas.
            } catch (error) {
                console.error('Error fetching price:', error);
                return null;
            }
        }

        function updatePrice(price) {
            document.getElementById('current-price').textContent = (price + Math.random() / 100).toFixed(5);
        }

        function updatePnL() {
            const currentPrice = parseFloat(document.getElementById('current-price').textContent);
            openPnL = 0;
            openPnLPorc = 0;
            orders.forEach((order, index) => {
                
                const pnl = order.type === 'Buy'
                    ? ((currentPrice - order.price) * order.leverage  * order.investment / order.price)
                    : ((order.price - currentPrice) * order.leverage  * order.investment / order.price);
                order.pnl = pnl;
                order.pnlPorc = pnl * 100 / order.investment;

                openPnL += pnl;
                openPnLPorc += order.pnlPorc;
                totalPnL = openPnL + closedPnL;
                totalPnLPorc = totalPnL * 100 / balanceInicial;

                    if (order.takeProfit != 0 && pnl / order.investment * 100 >= order.takeProfit || order.stopLoss != 0 && -pnl / order.investment * 100 >= order.stopLoss) {
                    closeOrder(index);
                }

                if (pnl + order.investment <= 0 ) {
                    closeOrder(index);
                }
            

            });

            if( balance <= 0 && orders.length == 0){
                    document.getElementById("reset-button").disabled = false;
                }else{
                    document.getElementById("reset-button").disabled = true;
                }

            if(orders.length == 0){
                    //totalPnL = closedPnL;
                    //totalPnLPorc = closedPnLPorc
                    openPnL = 0;
                    openPnLPorc = 0;
                }
            
            document.getElementById('pnl').innerHTML = `<h3>Total PNL: ${totalPnL.toFixed(2)} USDT | ${totalPnLPorc.toFixed(2)}%</h3>
             (Open: ${openPnL.toFixed(2)} | ${openPnLPorc.toFixed(2)}% / Closed: ${closedPnL.toFixed(2)} | ${closedPnLPorc.toFixed(2)}%)`;

            renderOrders();
        }

        function renderOrders() {
            const ordersList = document.getElementById('orders-list');
            ordersList.innerHTML = '';
            orders.slice().reverse().forEach((order, index) => {
                const row = document.createElement('tr');
                row.className = order.pnl >= 0 ? 'profit' : 'loss';
                row.innerHTML = `
                    <td>${order.type}</td>
                    <td>${order.price.toFixed(2)}</td>
                    <td>${order.leverage}</td>
                    <td>${order.investment.toFixed(2)}</td>
                    <td>${order.takeProfit}%</td>
                    <td>${order.stopLoss}%</td>
                    <td>${order.pnl.toFixed(2)}</td>
                    <td>${order.pnlPorc.toFixed(2)}</td>
                    <td><button class="btn-close" onclick="closeOrder(${orders.length - 1 - index})">Close</button></td>
                `;
                ordersList.appendChild(row);
            });
        }

        function renderClosedOrders() {
            const closedOrdersList = document.getElementById('closed-orders-list');
            closedOrdersList.innerHTML = '';
            closedOrders.slice().reverse().forEach(order => {
                const row = document.createElement('tr');
                row.className = order.pnl >= 0 ? 'profit' : 'loss';
                row.innerHTML = `
                    <td>${order.type}</td>
                    <td>${order.price.toFixed(2)}</td>
                    <td>${order.closePrice.toFixed(2)}</td>
                    <td>${order.leverage}</td>
                    <td>${order.investment.toFixed(2)}</td>
                    <td>${order.pnl.toFixed(2)}</td>
                    <td>${order.pnlPorc.toFixed(2)}</td>
                `;
                closedOrdersList.appendChild(row);
            });
        }

        function placeOrder(type) {
            const currentPrice = parseFloat(document.getElementById('current-price').textContent);
            if(!currentPrice){
                return;
            }
            const leverage = parseInt(document.getElementById('leverage').value);
            const takeProfit = parseFloat(document.getElementById('take-profit').value)||0;
            const stopLoss = parseFloat(document.getElementById('stop-loss').value)||0;
            const investmentOption = document.getElementById('investment-option').value;
            let investment = parseFloat(document.getElementById('investment-amount').value);

            if (investmentOption === 'percentage') {
                investment = (investment / 100) * balance;
            }

            if (investment > balance) {
                alert('Insufficient balance for this investment.');
                return;
            }

            if (!investment) {
                alert("put a value to investment, please!");
                return;
                
            }

            if (leverage > 125) {
                alert("the levereage can´t be upper than 125")
                document.getElementById('leverage').value = 125;
                return;
            }

            balance -= investment;
            document.getElementById('balance').textContent = balance.toFixed(2);

            orders.push({
                type,
                price: currentPrice,
                closePrice: 0,
                leverage,
                investment,
                takeProfit,
                stopLoss,
                pnl: 0,
                pnlPorc: 0
            });
            renderOrders();
        }

        function closeOrder(index) {
            const currentPrice = parseFloat(document.getElementById('current-price').textContent);
             const order = orders[index];

    // Actualiza el acumulador de PNL cerrado
    closedPnL += order.pnl;
    closedPnLPorc+= order.pnlPorc;

    //define precio de cierre
    order.closePrice = currentPrice;

    // Mueve la orden al historial de órdenes cerradas
    closedOrders.push(order);

    
    balance += order.investment + order.pnl;
    document.getElementById('balance').textContent = balance.toFixed(2);

    // Elimina la orden de la lista de abiertas
    orders.splice(index, 1);

            
            renderOrders();
            renderClosedOrders();
        }

        function closeAllOrders() {
    // Iterar sobre los índices en orden inverso
    for (let i = orders.length - 1; i >= 0; i--) {
        closeOrder(i);
    }
}

    function resetBalance(){
        const confirmation = confirm("Are you sure you want to reset your balance?");
        if(confirmation){
            balance = 100;
            document.getElementById('balance').textContent = balance.toFixed(2);
            //alert(`Balance has been reset to ${balance} USDT.`);
        }
    }

        document.getElementById('buy-button').addEventListener('click', () => placeOrder('Buy'));
        document.getElementById('sell-button').addEventListener('click', () => placeOrder('Sell'));
        document.getElementById('reset-button').addEventListener('click', () => resetBalance());
        document.getElementById('close-all-orders').addEventListener('click', closeAllOrders);

        document.getElementById('1x-button').addEventListener('click', () => {
            zoom = 1;
            priceHistory = [];
            (async () => {
    priceHistory.push(...(await fetchPriceHistory()));
    drawChart();
})();
            
        });
        document.getElementById('2x-button').addEventListener('click', () => {
            zoom = 2
            priceHistory = [];
            (async () => {
    priceHistory.push(...(await fetchPriceHistory()));
    drawChart();
})();
        });
        document.getElementById('4x-button').addEventListener('click', () => {
            zoom = 4
            priceHistory = [];
            (async () => {
    priceHistory.push(...(await fetchPriceHistory()));
    drawChart();
})();
        });
        document.getElementById('8x-button').addEventListener('click', () => {
        zoom = 8
        priceHistory = [];
            (async () => {
    priceHistory.push(...(await fetchPriceHistory()));
    drawChart();
})();
        });

let priceHistory = [];
const canvas = document.getElementById('price-chart');
const ctx = canvas.getContext('2d');
let zoom = 1

async function fetchPriceHistory() {
    const symbol = 'BTCUSDT'; // Cambia este valor si usas otro par
    const interval = '1s'; // Velas de 1 segundo
    let limit = 1000 / zoom; // Últimos 1000 segundos

    try {
        const response = await fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=${limit}`);
        const data = await response.json();
        return data.map(candle => parseFloat(candle[4])); // Extrae el precio de cierre (índice 4)
    } catch (error) {
        console.error('Error fetching price history:', error);
        return [];
    }
}

// Variables para almacenar la posición del mouse
let mouseX = null;
let mouseY = null;
let mouseInside = false;

// Evento para rastrear la posición del mouse
canvas.addEventListener('mousemove', event => {
    const rect = canvas.getBoundingClientRect();
    mouseX = event.clientX - rect.left;
    mouseY = event.clientY - rect.top;
    mouseInside = true;

    drawChart(); // Redibujar el gráfico inmediatamente con la línea del mouse
});

// Evento para detectar cuando el mouse sale del gráfico
canvas.addEventListener('mouseleave', () => {
    mouseX = null;
    mouseY = null;
    mouseInside = false;

    drawChart(); // Redibujar el gráfico para eliminar la línea
});

function drawCanvasBackground() {
    ctx.fillStyle = "black"; // Cambia a cualquier color que desees
    ctx.fillRect(0, 0, canvas.width, canvas.height);
}

function drawChart() {
    
    const currentPrice = parseFloat(document.getElementById('current-price').textContent);
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawCanvasBackground();

    if (priceHistory.length === 0) return;

     const minPrice = Math.min(...priceHistory);
     const maxPrice = Math.max(...priceHistory);

    const marginTop = 20; // Margen superior en píxeles
    const marginBottom = 20; // Margen inferior en píxeles
    const chartHeight = canvas.height - marginTop - marginBottom; // Altura útil del gráfico

    // Ajustar la escala para incluir el margen superior
    const scaleY = price => ((price - minPrice) / (maxPrice - minPrice)) * chartHeight + marginTop;

    // Draw price line
    ctx.beginPath();
    ctx.strokeStyle = '#007bff';
    ctx.lineWidth = 2;
    priceHistory.forEach((price, index) => {
        const x = (canvas.width / (priceHistory.length - 1)) * index;
        const y = canvas.height - scaleY(price);
        if (index === 0) {
            ctx.moveTo(x, y);
        } else {
            ctx.lineTo(x, y);
        }
    });
    ctx.stroke();

    // Draw orders
    orders.forEach(order => {
        let temp = 1;
        if(order.type == "Sell"){
            temp = -1;
        }
        const yOrder = canvas.height - scaleY(order.price);
        const yTakeProfit = canvas.height - scaleY(order.price * (1 + ((order.takeProfit / 100 * temp) / order.leverage)));
        const yStopLoss = canvas.height - scaleY(order.price * (1 - ((order.stopLoss / 100 * temp) / order.leverage)));
        //console.log(yTakeProfit, yOrder, yStopLoss, chartHeight, order.leverage)

        // Draw order price line
        ctx.strokeStyle = '#0000ff';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(0, yOrder);
        ctx.lineTo(canvas.width, yOrder);
        ctx.stroke();

        if(order.takeProfit){
            // Draw take profit line;
        ctx.strokeStyle = '#00ff00';
        ctx.lineWidth = 1;
        ctx.setLineDash([5, 5]); // Dotted line
        ctx.beginPath();
        ctx.moveTo(0, yTakeProfit);
        ctx.lineTo(canvas.width, yTakeProfit);
        ctx.stroke();
    }

        if(order.stopLoss){
            // Draw stop loss line
        ctx.strokeStyle = '#ff0000';
        ctx.lineWidth = 1;
        ctx.setLineDash([5, 5]); // Dotted line
        ctx.beginPath();
        ctx.moveTo(0, yStopLoss);
        ctx.lineTo(canvas.width, yStopLoss);
        ctx.stroke();
    }

        ctx.setLineDash([]); // Reset line style
    });

    // Dibujar los valores de precio máximo y mínimo
    ctx.fillStyle = 'white';
    ctx.font = '14px Arial';
    ctx.textAlign = 'right';
    ctx.fillText(maxPrice.toFixed(2), canvas.width - 5, marginTop - 5); // Precio máximo
    ctx.fillText(minPrice.toFixed(2), canvas.width - 5, canvas.height - marginBottom + 15); // Precio mínimo

    // Dibujar la línea del mouse si está dentro del gráfico
    if (mouseInside && mouseY >= marginTop && mouseY <= canvas.height - marginBottom) {
        const price = maxPrice - ((mouseY - marginTop) / chartHeight) * (maxPrice - minPrice);

        // Dibujar la línea horizontal
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(0, mouseY);
        ctx.lineTo(canvas.width, mouseY);
        ctx.stroke();

        // Dibujar el precio al inicio de la línea
        ctx.fillStyle = 'white';
        ctx.font = '12px Arial';
        ctx.textAlign = 'left';
        ctx.fillText(price.toFixed(2), 5, mouseY - 5);
    }

}

(async () => {
    priceHistory.push(...(await fetchPriceHistory()));
    drawChart();
})();

setInterval(async () => {
    const price = await fetchPrice();
    if (price) {
        updatePrice(price);
        updatePnL();
    }
}, 1000);

setInterval(() => {
    const currentPrice = parseFloat(document.getElementById('current-price').textContent);
    if (!isNaN(currentPrice)) {
        priceHistory.push(currentPrice);
        if (priceHistory.length > 1000) {
            priceHistory.shift(); // Keep the last 1000 prices
        }
        
        drawChart();
    }
}, 1000);
</script> -->

<script src="script.js"></script>
</body>
</html>
